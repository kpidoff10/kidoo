---
description: "Structure et conventions du projet kidoo-server. Organisation des fichiers, conventions de nommage, et bonnes pratiques Next.js App Router."
alwaysApply: true
globs:
  - kidoo-server/**/*
---

# Structure du Projet kidoo-server

## Organisation générale

```
kidoo-server/
├── app/                 # Next.js App Router
│   ├── api/            # Routes API
│   │   ├── auth/       # Routes d'authentification
│   │   └── kidoos/     # Routes Kidoos
│   ├── actions/        # Server Actions
│   │   └── auth.ts
│   ├── layout.tsx      # Layout racine
│   └── page.tsx        # Page d'accueil
├── auth.ts             # Configuration NextAuth
├── proxy.ts            # Proxy pour protection des routes
├── lib/                # Utilitaires et helpers
│   ├── prisma.ts       # Client Prisma singleton
│   ├── auth-helpers.ts  # Helpers d'authentification
│   └── shared.ts       # Wrapper pour types partagés
├── prisma/             # Prisma
│   ├── schema.prisma   # Schéma de base de données
│   └── README.md
└── types/              # Types TypeScript
    └── next-auth.d.ts  # Types NextAuth
```

## Conventions de nommage

### Fichiers
- **Routes API** : `route.ts` (ex: `app/api/kidoos/route.ts`)
- **Server Actions** : `camelCase.ts` (ex: `app/actions/auth.ts`)
- **Helpers** : `kebab-case.ts` (ex: `lib/auth-helpers.ts`)
- **Types** : `kebab-case.d.ts` (ex: `types/next-auth.d.ts`)

### Routes API
- **Handlers** : `GET`, `POST`, `PUT`, `DELETE` (noms de fonctions exportées)
- **Fichiers** : `route.ts` dans chaque dossier de route

### Server Actions
- **Fonctions** : `camelCase` (ex: `registerUser`, `checkEmailAvailability`)
- **Types de retour** : `PascalCase` (ex: `RegisterResult`)

## Routes API

### Structure

```
app/api/
├── auth/
│   ├── [...nextauth]/
│   │   └── route.ts        # NextAuth handlers
│   ├── mobile/
│   │   ├── login/
│   │   │   └── route.ts
│   │   └── logout/
│   │       └── route.ts
│   └── register/
│       └── route.ts
└── kidoos/
    ├── route.ts            # GET /api/kidoos, POST /api/kidoos
    └── [id]/
        └── route.ts        # GET /api/kidoos/[id], etc.
```

### Format des handlers

```typescript
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  // ...
}

export async function POST(request: NextRequest) {
  // ...
}
```

## Server Actions

### Structure

```
app/actions/
└── auth.ts
```

### Format

```typescript
'use server';

export async function myAction(): Promise<ActionResult> {
  // ...
}
```

## Imports

### Path aliases

```typescript
// ✅ CORRECT - Utiliser les aliases
import { prisma } from '@/lib/prisma';
import { requireAuth } from '@/lib/auth-helpers';
import { registerSchema } from '@/shared';

// ❌ INTERDIT - Imports relatifs
import { prisma } from '../../lib/prisma';
```

### Ordre des imports

1. React et Next.js
2. Bibliothèques externes
3. Imports internes (lib, shared, types)
4. Types

```typescript
import { NextRequest, NextResponse } from 'next/server';
import bcrypt from 'bcryptjs';

import { prisma } from '@/lib/prisma';
import { requireAuth } from '@/lib/auth-helpers';
import { registerSchema } from '@/shared';
import type { RegisterInput } from '@/shared';
```

## Configuration

### Variables d'environnement

```env
# Base de données
DATABASE_URL="postgresql://..."

# NextAuth
NEXTAUTH_SECRET="..."
NEXTAUTH_URL="http://localhost:3000"
```

### Next.js Config

Le fichier `next.config.ts` configure Webpack pour résoudre `shared/` :

```typescript
webpack: (config) => {
  config.resolve.alias = {
    ...config.resolve.alias,
    '@/shared': path.resolve(__dirname, '../shared'),
  };
  return config;
},
```

## Règles strictes

1. **Respecter la structure** - Routes API dans `app/api/`, Server Actions dans `app/actions/`
2. **Utiliser les path aliases** - `@/` au lieu de `../../`
3. **Routes API avec route.ts** - Un fichier `route.ts` par route
4. **Server Actions avec 'use server'** - Préfixe obligatoire
5. **Client singleton** - Utiliser `prisma` depuis `@/lib/prisma`
6. **Schémas partagés** - Utiliser `@/shared` pour les schémas Zod
