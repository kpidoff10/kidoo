# Structure du Projet kidoo-server

## Organisation générale

```
kidoo-server/
├── app/                          # Next.js App Router
│   ├── api/                      # Routes API
│   │   ├── auth/                 # Routes d'authentification
│   │   │   ├── [...nextauth]/    # Handlers NextAuth
│   │   │   ├── mobile/           # Auth spécifique mobile
│   │   │   │   ├── login/
│   │   │   │   └── logout/
│   │   │   └── register/
│   │   └── kidoos/               # Routes Kidoos
│   │       ├── route.ts          # GET (liste) + POST (créer)
│   │       └── [id]/
│   │           ├── route.ts      # GET + PUT + DELETE
│   │           ├── brightness/   # Config luminosité
│   │           ├── sleep-timeout/# Config sleep
│   │           └── commands/     # Commandes PubNub
│   │               └── common/
│   │                   ├── get-info/
│   │                   └── reboot/
│   ├── actions/                  # Server Actions
│   ├── layout.tsx
│   └── page.tsx
├── auth.ts                       # Configuration NextAuth
├── lib/                          # Utilitaires et helpers
│   ├── prisma.ts                 # Client Prisma singleton
│   ├── auth-helpers.ts           # Helpers d'authentification
│   └── pubnub.ts                 # Client PubNub
├── prisma/
│   └── schema.prisma             # Schéma de base de données
└── types/
    └── next-auth.d.ts            # Types NextAuth
```

## Conventions de nommage

### Fichiers
- **Routes API** : `route.ts` dans chaque dossier de route
- **Server Actions** : `camelCase.ts` (ex: `auth.ts`)
- **Helpers** : `kebab-case.ts` (ex: `auth-helpers.ts`)
- **Types** : `kebab-case.d.ts` (ex: `next-auth.d.ts`)

### Fonctions
- **Handlers API** : `GET`, `POST`, `PUT`, `PATCH`, `DELETE`
- **Server Actions** : `camelCase` (ex: `registerUser`)

## Organisation des routes API

### Structure hiérarchique

```
api/
├── auth/                         # Authentification
│   ├── [...nextauth]/route.ts    # NextAuth handlers
│   ├── mobile/
│   │   ├── login/route.ts        # POST - Login mobile
│   │   └── logout/route.ts       # POST - Logout mobile
│   └── register/route.ts         # POST - Inscription + GET - Check email
└── kidoos/
    ├── route.ts                  # GET (liste) + POST (créer)
    └── [id]/
        ├── route.ts              # GET + PUT + DELETE (CRUD)
        ├── brightness/route.ts   # PATCH - Config + PubNub
        ├── sleep-timeout/route.ts
        └── commands/             # Commandes PubNub temps réel
            └── common/
                ├── get-info/route.ts
                └── reboot/route.ts
```

### Séparation config vs commands

- **Config** (`/api/kidoos/[id]/brightness`) : Modifie la config en base + envoie commande PubNub
- **Commands** (`/api/kidoos/[id]/commands/`) : Commandes temps réel via PubNub uniquement

## Imports

### Path aliases

```typescript
// ✅ CORRECT - Utiliser les aliases
import { prisma } from '@/lib/prisma';
import { requireAuth } from '@/lib/auth-helpers';
import { brightnessCommandSchema } from '@/shared/schemas/api/kidoos/brightness';

// ❌ INTERDIT - Imports relatifs
import { prisma } from '../../lib/prisma';
```

### Ordre des imports

1. Next.js (NextRequest, NextResponse)
2. Bibliothèques externes
3. Lib interne (@/lib/*)
4. Shared (@/shared/*)
5. Types

```typescript
import { NextRequest, NextResponse } from 'next/server';
import bcrypt from 'bcryptjs';

import { prisma } from '@/lib/prisma';
import { requireAuth } from '@/lib/auth-helpers';
import { sendCommand, isPubNubConfigured } from '@/lib/pubnub';
import { brightnessCommandSchema } from '@/shared/schemas/api/kidoos/brightness';
import type { Kidoo } from '@prisma/client';
```

## Règles strictes

1. **Routes API dans `app/api/`** - Un fichier `route.ts` par route
2. **Utiliser les path aliases** - `@/` au lieu de `../../`
3. **Client Prisma singleton** - Toujours via `@/lib/prisma`
4. **Types Prisma partagés** - Import depuis `@/shared/types/prisma`
5. **Schémas partagés** - Import depuis `@/shared/schemas/`
