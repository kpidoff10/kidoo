---
description: "Règles Server Actions pour kidoo-server. Utiliser 'use server', valider avec Zod, et retourner des résultats typés."
alwaysApply: false
globs:
  - kidoo-server/app/actions/**/*.ts
---

# Règles du Module Server Actions

## Architecture

Les Server Actions sont dans `app/actions/` :
- Fonctions serveur exécutées côté serveur
- Préfixe `'use server'` obligatoire
- Validation avec schémas Zod partagés
- Format de réponse standardisé

## Structure d'une Server Action

```typescript
'use server';

import { prisma } from '@/lib/prisma';
import { registerSchema, type RegisterInput } from '@/shared';
import bcrypt from 'bcryptjs';

export type RegisterResult = 
  | { success: true; userId: string; message: string }
  | { success: false; error: string; field?: string };

export async function registerUser(data: RegisterInput): Promise<RegisterResult> {
  try {
    // 1. Validation
    const validationResult = registerSchema.safeParse(data);
    if (!validationResult.success) {
      const firstError = validationResult.error.issues[0];
      return {
        success: false,
        error: firstError.message,
        field: firstError.path[0] as string,
      };
    }

    // 2. Logique métier
    const { email, password, name } = validationResult.data;
    
    // 3. Vérifications
    const existingUser = await prisma.user.findUnique({
      where: { email },
    });

    if (existingUser) {
      return {
        success: false,
        error: 'Un compte avec cet email existe déjà',
        field: 'email',
      };
    }

    // 4. Création
    const hashedPassword = await bcrypt.hash(password, 10);
    const user = await prisma.user.create({
      data: { email, password: hashedPassword, name },
    });

    // 5. Retour
    return {
      success: true,
      userId: user.id,
      message: 'Compte créé avec succès',
    };
  } catch (error) {
    console.error('Erreur:', error);
    return {
      success: false,
      error: 'Une erreur est survenue',
    };
  }
}
```

## Préfixe 'use server'

**TOUJOURS ajouter `'use server'`** en haut du fichier :

```typescript
'use server';

export async function myAction() {
  // ...
}
```

**Règle** : Tous les fichiers dans `app/actions/` doivent avoir `'use server'`.

## Validation

**TOUJOURS valider avec les schémas Zod partagés** :

```typescript
import { registerSchema } from '@/shared';

const validationResult = registerSchema.safeParse(data);
if (!validationResult.success) {
  const firstError = validationResult.error.issues[0];
  return {
    success: false,
    error: firstError.message,
    field: firstError.path[0] as string,
  };
}

const { email, password } = validationResult.data;
```

**Règle** : Utiliser les schémas depuis `@/shared`, pas de validation custom.

## Format de réponse

**TOUJOURS retourner un type union** avec `success` :

```typescript
type ActionResult<T> = 
  | { success: true; data: T; message?: string }
  | { success: false; error: string; field?: string };

export async function myAction(): Promise<ActionResult<MyData>> {
  if (error) {
    return { success: false, error: '...', field: '...' };
  }
  
  return { success: true, data: result, message: '...' };
}
```

**Règle** : Utiliser ce format pour toutes les Server Actions.

## Revalidation

Pour revalider les caches Next.js :

```typescript
import { revalidatePath } from 'next/cache';

export async function updateKidoo(id: string, data: UpdateData) {
  // ... mise à jour
  
  revalidatePath('/kidoos');
  revalidatePath(`/kidoos/${id}`);
  
  return { success: true, data: updated };
}
```

## Gestion des erreurs

**TOUJOURS utiliser try/catch** :

```typescript
try {
  // Logique
} catch (error) {
  console.error('Erreur:', error);
  
  // Gérer les erreurs Prisma
  if (error instanceof Error) {
    if (error.message.includes('Unique constraint')) {
      return {
        success: false,
        error: 'Cette valeur existe déjà',
        field: 'email',
      };
    }
  }
  
  return {
    success: false,
    error: 'Une erreur est survenue',
  };
}
```

## Utilisation dans les composants

```typescript
'use client';

import { registerUser } from '@/app/actions/auth';

export default function RegisterForm() {
  const handleSubmit = async (data: FormData) => {
    const result = await registerUser({
      email: data.get('email') as string,
      password: data.get('password') as string,
      name: data.get('name') as string,
    });

    if (result.success) {
      // Succès
    } else {
      // Erreur
      console.error(result.error);
      console.error(result.field);
    }
  };
}
```

## Règles strictes

1. **Préfixe 'use server'** - Obligatoire en haut du fichier
2. **Valider avec Zod** - Utiliser les schémas partagés
3. **Format de réponse standardisé** - `{ success, ... }`
4. **Gérer les erreurs** - Toujours try/catch avec logging
5. **Revalider les caches** - Utiliser `revalidatePath` si nécessaire
6. **Types TypeScript** - Typer les résultats avec des unions
