# Règles Server Actions pour kidoo-server

## Quand utiliser Server Actions vs Routes API

| Cas d'usage | Solution |
|-------------|----------|
| Appels depuis l'app mobile | Route API (`/api/...`) |
| Appels depuis le web (forms, mutations) | Server Action |
| Commandes temps réel (PubNub) | Route API |
| Validation côté serveur simple | Server Action |

## Structure des Server Actions

Les Server Actions sont dans `app/actions/` :

```
app/actions/
└── auth.ts       # Actions d'authentification
```

## Format d'une Server Action

```typescript
'use server';

import { z } from 'zod';
import { prisma } from '@/lib/prisma';
import { monSchema } from '@/shared/schemas/...';

// Type de retour
type ActionResult = 
  | { success: true; data: {...} }
  | { success: false; error: string; field?: string };

export async function monAction(input: unknown): Promise<ActionResult> {
  try {
    // 1. Validation
    const validation = monSchema.safeParse(input);
    if (!validation.success) {
      return {
        success: false,
        error: validation.error.issues[0].message,
        field: validation.error.issues[0].path[0] as string,
      };
    }

    const data = validation.data;

    // 2. Logique métier
    const result = await prisma.model.create({ data });

    // 3. Retour
    return {
      success: true,
      data: result,
    };

  } catch (error) {
    console.error('Erreur dans monAction:', error);
    return {
      success: false,
      error: 'Une erreur est survenue',
    };
  }
}
```

## Exemple : Check email availability

```typescript
'use server';

import { prisma } from '@/lib/prisma';
import { emailSchema } from '@/shared/schemas/auth';

type CheckEmailResult =
  | { success: true; available: boolean; message: string }
  | { success: false; error: string };

export async function checkEmailAvailability(email: string): Promise<CheckEmailResult> {
  try {
    // Validation
    const validation = emailSchema.safeParse(email);
    if (!validation.success) {
      return { success: false, error: 'Email invalide' };
    }

    // Vérifier si l'email existe
    const user = await prisma.user.findUnique({
      where: { email },
      select: { id: true },
    });

    return {
      success: true,
      available: !user,
      message: user ? 'Cet email est déjà utilisé' : 'Cet email est disponible',
    };

  } catch (error) {
    console.error('Erreur checkEmailAvailability:', error);
    return { success: false, error: 'Une erreur est survenue' };
  }
}
```

## Utilisation côté client (web)

```typescript
'use client';

import { checkEmailAvailability } from '@/app/actions/auth';

export function EmailForm() {
  const handleCheck = async (email: string) => {
    const result = await checkEmailAvailability(email);
    
    if (result.success) {
      if (result.available) {
        // Email disponible
      } else {
        // Email déjà utilisé
      }
    } else {
      // Erreur
      console.error(result.error);
    }
  };

  return (/* ... */);
}
```

## Différences avec les Routes API

### Server Action

```typescript
'use server';

export async function createThing(input: CreateInput) {
  // Pas de NextRequest/NextResponse
  // Retourne directement un objet
  return { success: true, data: result };
}
```

### Route API

```typescript
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const body = await request.json();
  // ...
  return NextResponse.json({ success: true, data: result });
}
```

## Règles strictes

1. **'use server' obligatoire** - Première ligne du fichier
2. **Validation Zod** - Schémas depuis `@/shared/schemas/`
3. **Types de retour explicites** - Union `success: true | false`
4. **Pas de NextResponse** - Retourner des objets directement
5. **Gestion d'erreurs** - try/catch + logs
6. **Privilégier Routes API pour mobile** - Server Actions pour web uniquement
