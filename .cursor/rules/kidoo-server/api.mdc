# Règles API pour kidoo-server

## Structure d'une route API

Chaque route API doit suivre ce pattern :

```typescript
/**
 * Route API pour [description]
 * [METHOD] /api/[path]
 * 
 * Body: { ... } (si applicable)
 */

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { requireAuth } from '@/lib/auth-helpers';
import { monSchema } from '@/shared/schemas/...';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // 1. Vérifier l'authentification
    const authResult = requireAuth(request);
    if (!authResult.success) {
      return authResult.response;
    }
    const { userId } = authResult;

    // 2. Récupérer les params
    const { id } = await params;

    // 3. Valider le body (si POST/PUT/PATCH)
    const body = await request.json();
    const validation = monSchema.safeParse(body);
    if (!validation.success) {
      return NextResponse.json(
        { success: false, error: '...', details: validation.error.issues },
        { status: 400 }
      );
    }

    // 4. Vérifier ownership
    const resource = await prisma.kidoo.findUnique({ where: { id } });
    if (!resource) {
      return NextResponse.json(
        { success: false, error: 'Ressource non trouvée' },
        { status: 404 }
      );
    }
    if (resource.userId !== userId) {
      return NextResponse.json(
        { success: false, error: 'Accès non autorisé' },
        { status: 403 }
      );
    }

    // 5. Logique métier...

    // 6. Retourner la réponse
    return NextResponse.json({
      success: true,
      data: {...},
      message: 'Description du succès',
    });

  } catch (error) {
    console.error('Erreur:', error);
    return NextResponse.json(
      { success: false, error: 'Une erreur est survenue' },
      { status: 500 }
    );
  }
}
```

## Authentification obligatoire

**TOUTES les routes (sauf auth) doivent utiliser `requireAuth`** :

```typescript
import { requireAuth } from '@/lib/auth-helpers';

export async function GET(request: NextRequest) {
  const authResult = requireAuth(request);
  if (!authResult.success) {
    return authResult.response;
  }
  const { userId } = authResult;
  // ...
}
```

## Validation obligatoire avec schémas partagés

**TOUTES les routes avec body doivent valider avec un schéma Zod de `@/shared/schemas/`** :

```typescript
import { brightnessCommandSchema } from '@/shared/schemas/api/kidoos/brightness';

const body = await request.json();
const validation = brightnessCommandSchema.safeParse(body);

if (!validation.success) {
  return NextResponse.json(
    {
      success: false,
      error: 'Message d\'erreur utilisateur',
      details: validation.error.issues,
    },
    { status: 400 }
  );
}

const { value } = validation.data;
```

## Format des réponses

### Succès

```typescript
return NextResponse.json({
  success: true,
  data: { ... },           // Données retournées
  message: 'Description',  // Message optionnel
});
```

### Erreur

```typescript
return NextResponse.json(
  {
    success: false,
    error: 'Message d\'erreur',
    field: 'nomDuChamp',           // Optionnel, pour erreurs de validation
    details: [...],                // Optionnel, en dev uniquement
  },
  { status: 400 | 401 | 403 | 404 | 500 }
);
```

### Codes de statut

| Code | Usage |
|------|-------|
| 200 | Succès GET/PUT/PATCH/DELETE |
| 201 | Succès POST (création) |
| 400 | Erreur de validation |
| 401 | Non authentifié |
| 403 | Non autorisé (ownership) |
| 404 | Ressource non trouvée |
| 409 | Conflit (ex: email déjà utilisé) |
| 500 | Erreur serveur |
| 502 | Erreur PubNub |
| 503 | Service non configuré |

## Routes avec PubNub

Pour les routes qui envoient des commandes à l'ESP32 :

```typescript
import { sendCommand, isPubNubConfigured } from '@/lib/pubnub';

// 1. Vérifier que le Kidoo a une adresse MAC
if (!kidoo.macAddress) {
  return NextResponse.json(
    { success: false, error: 'Kidoo non configuré (adresse MAC manquante)' },
    { status: 400 }
  );
}

// 2. Vérifier PubNub
if (!isPubNubConfigured()) {
  return NextResponse.json(
    { success: false, error: 'PubNub non configuré sur le serveur' },
    { status: 503 }
  );
}

// 3. Envoyer la commande
const sent = await sendCommand(kidoo.macAddress, 'brightness', { value });

if (!sent) {
  return NextResponse.json(
    { success: false, error: 'Échec de l\'envoi de la commande au Kidoo' },
    { status: 502 }
  );
}
```

## Conversion des types pour JSON

### Dates → ISO strings

```typescript
const kidooWithISOStrings = {
  ...kidoo,
  lastConnected: kidoo.lastConnected?.toISOString() || null,
  createdAt: kidoo.createdAt.toISOString(),
  updatedAt: kidoo.updatedAt.toISOString(),
};
```

### BigInt → Number

```typescript
const config = {
  storageTotalBytes: kidoo.configBasic.storageTotalBytes 
    ? Number(kidoo.configBasic.storageTotalBytes) 
    : null,
};
```

## Règles strictes

1. **`requireAuth` obligatoire** - Sauf routes auth publiques
2. **Validation Zod obligatoire** - Schémas depuis `@/shared/schemas/`
3. **Vérifier ownership** - `resource.userId !== userId` → 403
4. **Format de réponse standard** - `{ success, data?, error?, message? }`
5. **Convertir dates et BigInt** - Pour compatibilité JSON
6. **Gérer les erreurs** - try/catch + logs + réponse 500
