# Règles pour les Schémas et Types Partagés

## Architecture shared/

Le dossier `shared/` contient les schémas Zod et types partagés entre `kidoo-server` et `kidoo-app` :

```
shared/
├── schemas/                      # Schémas de validation Zod
│   ├── auth.ts                   # Schémas authentification
│   ├── kidoo.ts                  # Schémas CRUD Kidoo
│   ├── tag.ts                    # Schémas tags
│   └── api/                      # Schémas par route API
│       └── kidoos/
│           ├── brightness/
│           │   ├── schema.ts     # Schéma Zod + constantes
│           │   ├── type.ts       # Types de réponse
│           │   └── index.ts      # Re-exports
│           └── sleep-timeout/
│               ├── schema.ts
│               ├── type.ts
│               └── index.ts
└── types/
    └── prisma/                   # Client Prisma généré
        ├── index.d.ts            # Types TypeScript
        ├── index.js              # Client JS
        └── schema.prisma         # Copie du schéma
```

## Schémas par route API

Chaque route API avec body a un dossier dans `shared/schemas/api/` avec 3 fichiers :

### 1. schema.ts - Schéma Zod + constantes

```typescript
/**
 * Schéma pour la commande brightness
 */

import { z } from 'zod';

// Constantes exportées pour réutilisation (UI, validation côté client)
export const BRIGHTNESS_LIMITS = {
  min: 1,
  max: 100,
} as const;

// Schéma Zod
export const brightnessCommandSchema = z.object({
  value: z.number()
    .int()
    .min(BRIGHTNESS_LIMITS.min, `Minimum ${BRIGHTNESS_LIMITS.min}%`)
    .max(BRIGHTNESS_LIMITS.max, `Maximum ${BRIGHTNESS_LIMITS.max}%`),
});

// Type inféré
export type BrightnessCommandInput = z.infer<typeof brightnessCommandSchema>;
```

### 2. type.ts - Types de réponse

```typescript
/**
 * Types de réponse pour la commande brightness
 */

export interface BrightnessResponse {
  brightness: number;
}
```

### 3. index.ts - Re-exports

```typescript
export * from './schema';
export * from './type';
```

## Schémas généraux

### auth.ts

```typescript
import { z } from 'zod';

export const emailSchema = z.string().email('Email invalide');

export const passwordSchema = z.string()
  .min(8, 'Le mot de passe doit contenir au moins 8 caractères');

export const registerSchema = z.object({
  email: emailSchema,
  password: passwordSchema,
  name: z.string().min(2, 'Le nom doit contenir au moins 2 caractères'),
});

export const loginSchema = z.object({
  email: emailSchema,
  password: z.string().min(1, 'Le mot de passe est requis'),
});

export type RegisterInput = z.infer<typeof registerSchema>;
export type LoginInput = z.infer<typeof loginSchema>;
```

### kidoo.ts

```typescript
import { z } from 'zod';

export const createKidooInputSchema = z.object({
  name: z.string().min(1, 'Le nom est requis').max(100, 'Nom trop long'),
  model: z.string().min(1, 'Le modèle est requis'),
  macAddress: z.string().optional(),
  deviceId: z.string().uuid(),
  firmwareVersion: z.string().optional(),
});

export const updateKidooInputSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  macAddress: z.string().optional(),
  wifiSSID: z.string().optional(),
});

export type CreateKidooInput = z.infer<typeof createKidooInputSchema>;
export type UpdateKidooInput = z.infer<typeof updateKidooInputSchema>;
```

## Imports dans kidoo-server

```typescript
// Schémas auth
import { loginSchema, registerSchema } from '@/shared/schemas/auth';

// Schémas kidoo
import { createKidooInputSchema, updateKidooInputSchema } from '@/shared/schemas/kidoo';

// Schémas API spécifiques
import { brightnessCommandSchema, BRIGHTNESS_LIMITS } from '@/shared/schemas/api/kidoos/brightness';

// Types Prisma
import { Kidoo, User, Tag } from '@/shared/types/prisma';
```

## Création d'un nouveau schéma API

Pour une nouvelle route `/api/kidoos/[id]/ma-route` :

1. Créer le dossier `shared/schemas/api/kidoos/ma-route/`

2. Créer `schema.ts` :
```typescript
import { z } from 'zod';

export const MA_ROUTE_LIMITS = {
  min: 0,
  max: 100,
} as const;

export const maRouteSchema = z.object({
  value: z.number().min(MA_ROUTE_LIMITS.min).max(MA_ROUTE_LIMITS.max),
});

export type MaRouteInput = z.infer<typeof maRouteSchema>;
```

3. Créer `type.ts` :
```typescript
export interface MaRouteResponse {
  result: number;
}
```

4. Créer `index.ts` :
```typescript
export * from './schema';
export * from './type';
```

5. Utiliser dans la route :
```typescript
import { maRouteSchema } from '@/shared/schemas/api/kidoos/ma-route';
```

## Règles strictes

1. **JAMAIS de duplication** - Schémas uniquement dans `shared/`
2. **Structure 3 fichiers** - schema.ts + type.ts + index.ts pour chaque route API
3. **Constantes exportées** - `LIMITS` pour réutilisation côté client
4. **Types inférés** - Utiliser `z.infer<typeof schema>` 
5. **Messages en français** - Erreurs Zod lisibles par l'utilisateur
6. **Import depuis @/shared/** - Jamais de chemins relatifs
