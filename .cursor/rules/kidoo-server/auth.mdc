# Règles d'authentification pour kidoo-server

## Architecture

L'authentification utilise **NextAuth v5** avec deux modes :
- **Web** : Sessions NextAuth classiques via `[...nextauth]`
- **Mobile** : Routes dédiées `/api/auth/mobile/` (login/logout)

## Routes d'authentification

```
api/auth/
├── [...nextauth]/route.ts    # Handlers NextAuth (GET, POST)
├── mobile/
│   ├── login/route.ts        # POST - Login mobile
│   └── logout/route.ts       # POST - Logout mobile
└── register/route.ts         # POST - Inscription + GET - Check email
```

## Configuration NextAuth

Fichier `auth.ts` à la racine :

```typescript
import NextAuth from 'next-auth';
import { PrismaAdapter } from '@auth/prisma-adapter';
import Credentials from 'next-auth/providers/credentials';
import { prisma } from '@/lib/prisma';

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    Credentials({
      // Configuration credentials...
    }),
  ],
  // ...
});
```

## Helpers d'authentification

### requireAuth

Utilisé dans **TOUTES les routes API protégées** :

```typescript
import { requireAuth } from '@/lib/auth-helpers';

export async function GET(request: NextRequest) {
  const authResult = requireAuth(request);
  if (!authResult.success) {
    return authResult.response;
  }
  
  const { userId } = authResult;
  // Continuer avec userId...
}
```

### Structure de requireAuth

```typescript
// lib/auth-helpers.ts
export function requireAuth(request: NextRequest): AuthResult {
  // Vérifie le header Authorization ou la session
  // Retourne { success: true, userId } ou { success: false, response }
}
```

## Routes publiques vs protégées

### Routes publiques (sans requireAuth)
- `POST /api/auth/register` - Inscription
- `GET /api/auth/register` - Vérifier email disponible
- `POST /api/auth/mobile/login` - Login mobile
- `POST /api/auth/mobile/logout` - Logout mobile
- `[...nextauth]` - Handlers NextAuth

### Routes protégées (avec requireAuth)
- **TOUTES les autres routes** (`/api/kidoos/*`, etc.)

## Login mobile

```typescript
// POST /api/auth/mobile/login
import { loginSchema } from '@/shared/schemas/auth';

export async function POST(request: NextRequest) {
  const body = await request.json();
  
  // Validation
  const validation = loginSchema.safeParse(body);
  if (!validation.success) {
    return NextResponse.json(
      { success: false, error: '...', field: '...' },
      { status: 400 }
    );
  }

  const { email, password } = validation.data;

  // Vérifier utilisateur
  const user = await prisma.user.findUnique({ where: { email } });
  if (!user || !user.password) {
    return NextResponse.json(
      { success: false, error: 'Email ou mot de passe incorrect', field: 'credentials' },
      { status: 401 }
    );
  }

  // Vérifier mot de passe
  const isValid = await bcrypt.compare(password, user.password);
  if (!isValid) {
    return NextResponse.json(
      { success: false, error: 'Email ou mot de passe incorrect', field: 'credentials' },
      { status: 401 }
    );
  }

  // Succès
  return NextResponse.json({
    success: true,
    message: 'Connexion réussie',
    user: { id: user.id, email: user.email, name: user.name || '' },
  });
}
```

## Inscription

```typescript
// POST /api/auth/register
import { registerSchema } from '@/shared/schemas/auth';

export async function POST(request: NextRequest) {
  const body = await request.json();
  
  // Validation
  const validation = registerSchema.safeParse(body);
  // ...

  // Vérifier unicité email
  const existing = await prisma.user.findUnique({ where: { email } });
  if (existing) {
    return NextResponse.json(
      { success: false, error: 'Un compte avec cet email existe déjà', field: 'email' },
      { status: 409 }
    );
  }

  // Hasher le mot de passe
  const hashedPassword = await bcrypt.hash(password, 10);

  // Créer l'utilisateur
  const user = await prisma.user.create({
    data: { email, password: hashedPassword, name },
  });

  return NextResponse.json(
    { success: true, message: 'Compte créé avec succès', user: {...} },
    { status: 201 }
  );
}
```

## Schémas de validation

Tous les schémas auth sont dans `@/shared/schemas/auth.ts` :

```typescript
import { loginSchema, registerSchema, emailSchema } from '@/shared/schemas/auth';
```

| Schéma | Champs |
|--------|--------|
| `emailSchema` | Email valide |
| `passwordSchema` | Min 8 caractères |
| `loginSchema` | email + password |
| `registerSchema` | email + password + name (min 2 chars) |

## Règles strictes

1. **requireAuth obligatoire** - Sur toutes les routes sauf auth publiques
2. **Schémas partagés** - Validation avec `@/shared/schemas/auth`
3. **Bcrypt** - Hash des mots de passe avec `bcrypt.hash(password, 10)`
4. **Messages génériques** - "Email ou mot de passe incorrect" (ne pas révéler si l'email existe)
5. **field dans les erreurs** - Indiquer le champ en erreur pour l'UI
