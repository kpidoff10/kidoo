# Règles Prisma et Base de Données pour kidoo-server

## Architecture des types Prisma

Le client Prisma est **généré dans `shared/types/prisma/`** pour être partagé entre le serveur et l'app mobile :

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
  output   = "../../shared/types/prisma"
}
```

## Client Prisma singleton

Toujours utiliser le client depuis `@/lib/prisma` :

```typescript
// lib/prisma.ts
import { PrismaClient } from '@/shared/types/prisma';
import { PrismaPg } from '@prisma/adapter-pg';
import { Pool } from 'pg';

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const adapter = new PrismaPg(pool);

export const prisma = new PrismaClient({ adapter });
```

### Import correct

```typescript
// ✅ CORRECT
import { prisma } from '@/lib/prisma';

// ❌ INTERDIT - Ne jamais créer un nouveau client
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
```

## Modèles de données

### User

```prisma
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  password      String?
  
  kidoos        Kidoo[]
  tags          Tag[]
  files         File[]
}
```

### Kidoo

```prisma
model Kidoo {
  id              String    @id @default(uuid())
  name            String
  model           String    @default("classic")
  macAddress      String?
  deviceId        String    @unique
  firmwareVersion String?
  isConnected     Boolean   @default(false)
  wifiSSID        String?
  userId          String?
  
  brightness      Int       @default(100)
  sleepTimeout    Int       @default(30000)
  
  user            User?     @relation(...)
  tags            Tag[]
  configBasic     KidooConfigBasic?
}
```

### Tag

```prisma
model Tag {
  id        String   @id @default(uuid())
  tagId     String?  @unique    # UUID écrit sur le tag NFC
  uid       String?             # UID matériel du tag
  name      String?
  type      TagType?            # MUSIC, STORY, SOUND
  kidooId   String
  userId    String
  
  kidoo           Kidoo  @relation(...)
  multimediaFiles File[]
}
```

### File

```prisma
model File {
  id           String   @id @default(uuid())
  tagId        String
  userId       String
  url          String              # URL Cloudflare R2
  path         String              # Chemin dans le bucket
  fileName     String
  originalName String
  size         Int
  mimeType     String
  order        Int      @default(0)
  disabled     Boolean  @default(false)
}
```

### KidooConfigBasic

```prisma
model KidooConfigBasic {
  id                 String   @id @default(uuid())
  kidooId            String   @unique
  
  storageTotalBytes  BigInt?
  storageFreeBytes   BigInt?
  storageUsedBytes   BigInt?
  storageLastUpdated DateTime?
  
  kidoo              Kidoo    @relation(...)
}
```

## Conventions de requêtes

### Vérifier ownership

```typescript
const kidoo = await prisma.kidoo.findUnique({ where: { id } });

if (!kidoo) {
  return NextResponse.json({ success: false, error: 'Non trouvé' }, { status: 404 });
}

if (kidoo.userId !== userId) {
  return NextResponse.json({ success: false, error: 'Accès non autorisé' }, { status: 403 });
}
```

### Include relations

```typescript
const kidoo = await prisma.kidoo.findUnique({
  where: { id },
  include: {
    configBasic: true,
    tags: true,
  },
});
```

### Select pour optimiser

```typescript
const user = await prisma.user.findUnique({
  where: { email },
  select: { id: true },  // Ne récupérer que l'id
});
```

### Upsert pour config

```typescript
await prisma.kidooConfigBasic.upsert({
  where: { kidooId },
  update: { brightness: value },
  create: { kidooId, brightness: value },
});
```

## Conversion des types pour JSON

### BigInt → Number

Les BigInt ne sont pas sérialisables en JSON :

```typescript
const config = {
  storageTotalBytes: kidoo.configBasic?.storageTotalBytes 
    ? Number(kidoo.configBasic.storageTotalBytes) 
    : null,
};
```

### Date → ISO string

```typescript
const data = {
  createdAt: kidoo.createdAt.toISOString(),
  updatedAt: kidoo.updatedAt.toISOString(),
  lastConnected: kidoo.lastConnected?.toISOString() || null,
};
```

## Migrations

```bash
# Créer une migration
npx prisma migrate dev --name nom_migration

# Appliquer en production
npx prisma migrate deploy

# Regénérer le client (dans shared/)
npx prisma generate
```

## Règles strictes

1. **Client singleton** - Toujours `import { prisma } from '@/lib/prisma'`
2. **Types partagés** - Client généré dans `shared/types/prisma/`
3. **Vérifier ownership** - `resource.userId !== userId` avant toute opération
4. **Convertir BigInt** - `Number(bigint)` pour JSON
5. **Convertir Date** - `.toISOString()` pour JSON
6. **Cascade delete** - Relations configurées avec `onDelete: Cascade`
