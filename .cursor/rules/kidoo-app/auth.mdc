---
description: "Règles d'authentification pour kidoo-app. Toujours utiliser AuthContext, les composants auth préfabriqués, et les schémas Zod partagés pour la validation."
alwaysApply: false
globs:
  - kidoo-app/contexts/AuthContext.tsx
  - kidoo-app/services/authService.ts
  - kidoo-app/screens/auth/**/*.tsx
  - kidoo-app/app/(auth)/**/*.tsx
---

# Règles du Module Authentification

## Architecture

L'authentification utilise :
- **AuthContext** (`contexts/AuthContext.tsx`) - Gestion de l'état utilisateur
- **authService** (`services/authService.ts`) - Communication avec l'API
- **AsyncStorage** - Persistance de la session locale
- **Schémas Zod partagés** (`@/shared`) - Validation

## Utilisation

### AuthContext

```tsx
import { useAuth } from '@/contexts/AuthContext';

function MonComposant() {
  const { user, isAuthenticated, isLoading, login, register, logout } = useAuth();
  
  // user: SessionUser | null
  // isAuthenticated: boolean
  // isLoading: boolean (pendant le chargement initial)
}
```

### Login

```tsx
const { login } = useAuth();

const result = await login({
  email: 'user@example.com',
  password: 'password123',
});

if (result.success) {
  // Connexion réussie
  router.replace('/(tabs)');
} else {
  // Erreur
  console.error(result.error);
  console.error(result.field); // Champ en erreur si validation
}
```

### Register

```tsx
const { register } = useAuth();

const result = await register({
  name: 'John Doe',
  email: 'user@example.com',
  password: 'password123',
});

if (result.success) {
  // Inscription réussie
  router.replace('/(tabs)');
} else {
  // Erreur
  console.error(result.error);
  console.error(result.field);
}
```

### Logout

```tsx
const { logout } = useAuth();

await logout();
router.replace('/(auth)/login');
```

## Protection des routes

La protection est gérée dans `app/_layout.tsx` :

```tsx
// Redirection automatique basée sur l'état d'authentification
useEffect(() => {
  if (isLoading) return;
  
  const inAuthGroup = segments[0] === '(auth)';
  
  if (!isAuthenticated && !inAuthGroup) {
    router.replace('/(auth)/login');
  } else if (isAuthenticated && inAuthGroup) {
    router.replace('/(tabs)');
  }
}, [isAuthenticated, isLoading, segments]);
```

## Composants auth

Utiliser les composants préfabriqués :

```tsx
import { AuthHeader, FormField, AuthButton, AuthLink } from '@/screens/auth';

<AuthHeader
  title={t('auth.login.title')}
  subtitle={t('auth.login.subtitle')}
/>

<FormField
  label={t('auth.login.email')}
  value={email}
  onChangeText={setEmail}
  error={errors.email}
  placeholder="exemple@email.com"
  autoCapitalize="none"
  keyboardType="email-address"
/>

<AuthButton
  label={t('auth.login.loginButton')}
  onPress={handleLogin}
  loading={isLoading}
  disabled={!isFormValid}
/>

<AuthLink
  prompt={t('auth.login.noAccount')}
  linkText={t('auth.login.signUp')}
  onPress={() => router.push('/(auth)/register')}
/>
```

## Validation

Utiliser les schémas Zod partagés :

```tsx
import { loginSchema, registerSchema } from '@/types/shared';

// Validation
const result = loginSchema.safeParse(formData);
if (!result.success) {
  // Gérer les erreurs de validation
  const errors = {};
  result.error.issues.forEach((issue) => {
    errors[issue.path[0]] = issue.message;
  });
}
```

## Persistance de session

La session est automatiquement :
- **Sauvegardée** dans AsyncStorage après login/register
- **Chargée** au démarrage de l'app
- **Supprimée** lors du logout

**Pas besoin de gérer manuellement** - AuthContext s'en charge.

## Headers API

Pour les requêtes API authentifiées, l'ID utilisateur est envoyé via le header `X-User-Id` :

```tsx
// Dans services/api.ts
headers: {
  'X-User-Id': userId, // Récupéré depuis AsyncStorage
  'Content-Type': 'application/json',
}
```

## Règles strictes

1. **Toujours utiliser AuthContext** - Ne pas créer de state utilisateur local
2. **Utiliser les composants auth** - AuthHeader, FormField, AuthButton, AuthLink
3. **Valider avec Zod** - Utiliser les schémas partagés
4. **Gérer les erreurs** - Toujours vérifier `result.success`
5. **Redirection automatique** - Laisser `_layout.tsx` gérer les redirections
