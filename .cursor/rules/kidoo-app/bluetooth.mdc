---
description: "Règles Bluetooth pour kidoo-app. Toujours vérifier isAvailable avant d'utiliser le Bluetooth, utiliser BluetoothScanModal pour l'UI, et gérer les erreurs avec AlertMessage."
alwaysApply: false
globs:
  - kidoo-app/hooks/use-bluetooth-scan.ts
  - kidoo-app/screens/kidoo/bluetooth-scan-modal/**/*.tsx
  - kidoo-app/app/**/*kidoo*.tsx
---

# Règles du Module Bluetooth

## Architecture

Le Bluetooth utilise :
- **react-native-ble-plx** - Bibliothèque BLE
- **useBluetoothScan** (`hooks/use-bluetooth-scan.ts`) - Hook de scan
- **BluetoothScanModal** (`screens/kidoo/bluetooth-scan-modal/index.tsx`) - UI de scan

## Compatibilité Expo Go

**IMPORTANT** : `react-native-ble-plx` nécessite un **build natif**. Il ne fonctionne pas dans Expo Go.

### Build natif requis

```bash
# Android
npm run android
# ou
expo run:android

# iOS
npm run ios
# ou
expo run:ios
```

Voir `BUILD_NATIVE.md` pour les instructions complètes.

## Utilisation du hook

### useBluetoothScan

```tsx
import { useBluetoothScan } from '@/hooks/use-bluetooth-scan';

const {
  isScanning,
  scannedDevices,
  isBluetoothEnabled,
  error,
  isAvailable,        // false si en Expo Go
  startScan,
  stopScan,
  resetDevices,
} = useBluetoothScan();
```

### Vérifier la disponibilité

```tsx
const { isAvailable } = useBluetoothScan();

if (!isAvailable) {
  // Afficher un message : "Le Bluetooth nécessite un build natif"
  return <AlertMessage message="..." type="error" />;
}
```

## Composant BluetoothScanModal

```tsx
import { BluetoothScanModal } from '@/screens/kidoo';
import { useBottomSheet } from '@/components/ui/bottom-sheet';

const { ref, present } = useBottomSheet();

<BluetoothScanModal
  ref={ref}
  onDeviceSelect={(device) => {
    // device: { id, name, deviceId }
    console.log('Device sélectionné:', device);
  }}
  onClose={() => {
    // Callback quand la modale se ferme
  }}
/>

// Ouvrir la modale
present();
```

## Filtrage des appareils

Le hook filtre automatiquement les appareils par nom :
- "Kidoo"
- "Kidoo mini"
- "KIDOO"
- "KIDOO MINI"

**Règle** : Les noms sont définis dans `hooks/use-bluetooth-scan.ts` dans `KIDOO_DEVICE_NAMES`.

## Permissions

Les permissions sont gérées automatiquement :
- **Android** : Demande automatique des permissions (BLUETOOTH_SCAN, BLUETOOTH_CONNECT, ACCESS_FINE_LOCATION)
- **iOS** : Géré par le système via `infoPlist` dans `app.json`

## États du scan

```tsx
const {
  isScanning,        // true pendant le scan
  scannedDevices,    // Array<ScannedDevice>
  isBluetoothEnabled, // État du Bluetooth
  error,             // Message d'erreur si présent
} = useBluetoothScan();
```

## Format des appareils scannés

```typescript
interface ScannedDevice {
  id: string;              // ID unique du device
  name: string | null;      // Nom du device
  rssi: number | null;     // Signal RSSI (dBm)
  isConnectable: boolean | null;
}
```

## Gestion des erreurs

```tsx
const { error, isBluetoothEnabled, isAvailable } = useBluetoothScan();

// Afficher les erreurs
<AlertMessage
  message={t('kidoos.scan.bluetoothNotAvailable')}
  type="error"
  visible={!isAvailable}
/>

<AlertMessage
  message={error || ''}
  type="error"
  visible={!!error && isAvailable}
/>

<AlertMessage
  message={t('kidoos.scan.bluetoothDisabled')}
  type="warning"
  visible={isAvailable && !isBluetoothEnabled}
/>
```

## Règles strictes

1. **Toujours vérifier `isAvailable`** - Avant d'utiliser le Bluetooth
2. **Utiliser BluetoothScanModal** - Pour l'UI de scan
3. **Gérer les erreurs** - Afficher les messages d'erreur avec AlertMessage
4. **Build natif requis** - Documenter dans les instructions
5. **Permissions** - Vérifier que les permissions sont dans `app.json`

## RSSI (Signal)

Le RSSI est affiché avec des couleurs :
- **Excellent** (> -50 dBm) : Vert
- **Bon** (-50 à -70 dBm) : Orange
- **Faible** (< -70 dBm) : Rouge

Les couleurs sont dans `theme/colors.ts` : `rssiExcellent`, `rssiGood`, `rssiPoor`.
